<!DOCTYPE html>
<html>
<head>
  <title>Answer Sheet Scanner</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #video { width: 100%; max-width: 500px; border: 2px solid #ccc; }
    #result { margin-top: 20px; padding: 10px; background: #f0f0f0; }
    #input { margin: 10px 0; }
    #error { color: red; }
    .answers { font-family: monospace; white-space: pre-line; }
    .correct { color: green; }
    .incorrect { color: red; }
    .section { margin: 10px 0; padding: 5px; border: 1px solid #ccc; }
    .controls { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Answer Sheet Scanner</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div id="input">
    <label>Enter Answer Key (60 chars):</label>
    <input type="text" id="answerKey" maxlength="60" placeholder="ABCDE...">
    <button onclick="setKey()">Set Key</button>
  </div>
  
  <div class="controls">
    <button onclick="startScan()">Start Scanning</button>
    <button onclick="saveResult()">Save Result</button>
  </div>
  
  <div id="result">Click "Start Scanning" to begin...</div>
  <div id="error"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    let answerKey = '';
    let currentAnswers = null;
    let scanning = false;

    // Set answer key
    function setKey() {
      answerKey = document.getElementById('answerKey').value.toUpperCase();
      if (answerKey.length !== 60) {
        errorDiv.textContent = 'Answer key must be 60 characters long!';
        return;
      }
      errorDiv.textContent = '';
    }

    // Start scanning
    function startScan() {
      if (!answerKey) {
        errorDiv.textContent = 'Set answer key first!';
        return;
      }
      scanning = true;
      currentAnswers = null;
      result.innerHTML = 'Scanning...';
      scan();
    }

    // Stop scanning and save result
    function saveResult() {
      if (!currentAnswers) {
        errorDiv.textContent = 'No results to save!';
        return;
      }
      const dataStr = "data:text/json;charset=utf-8," + 
        encodeURIComponent(JSON.stringify({
          answers: currentAnswers,
          score: calculateScore(currentAnswers)
        }));
      const a = document.createElement('a');
      a.href = dataStr;
      a.download = `answers_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }

    // Camera access
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => video.srcObject = stream)
      .catch(err => errorDiv.textContent = `Camera error: ${err.message}`);

    video.addEventListener('loadedmetadata', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    });

    // Main scanning function
    function scan() {
      if (!scanning) return;
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Process image
        const filteredData = removeGreenBackground(imageData);
        const answers = detectAnswers(filteredData);
        
        if (answers && answers.length === 60) {
          currentAnswers = answers;
          result.innerHTML = displayResults(answers);
          scanning = false; // Stop after one successful scan
        }
      }
      if (scanning) requestAnimationFrame(scan);
    }

    // Remove green background
    function removeGreenBackground(imageData) {
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Convert greenish pixels to grayscale
        if (g > r + 30 && g > b + 30) {
          const avg = (r + g + b) / 3;
          data[i] = avg;
          data[i + 1] = avg;
          data[i + 2] = avg;
        }
      }
      return imageData;
    }

    // Detect answers in 4 sections
    function detectAnswers(imageData) {
      const ROWS = 15;
      const SECTIONS = 4;
      const OPTIONS = 5;
      const CELL_HEIGHT = 6 * 3;
      const CELL_WIDTH = 6 * 3;
      const SECTION_WIDTH = 6 * 3; // Question + 5 options

      const answers = [];
      
      for (let section = 0; section < SECTIONS; section++) {
        for (let row = 0; row < ROWS; row++) {
          for (let opt = 0; opt < OPTIONS; opt++) {
            // Calculate bubble position
            const x = 50 + section * SECTION_WIDTH + opt * CELL_WIDTH;
            const y = 50 + row * CELL_HEIGHT;

            // Check if bubble is shaded
            const brightness = getPixelBrightness(imageData, x, y);
            if (brightness < 100) {
              const option = String.fromCharCode(65 + opt); // A-E
              answers.push(option);
            }
          }
        }
      }
      return answers.slice(0, 60);
    }

    // Get pixel brightness
    function getPixelBrightness(imageData, x, y) {
      const index = (y * imageData.width + x) * 4;
      const r = imageData.data[index];
      const g = imageData.data[index + 1];
      const b = imageData.data[index + 2];
      return (r + g + b) / 3;
    }

    // Display results in 4 sections
    function displayResults(answers) {
      if (!answerKey) return 'Set answer key first!';
      
      let html = '';
      for (let section = 0; section < 4; section++) {
        const start = section * 15;
        const end = start + 15;
        const sectionAnswers = answers.slice(start, end);
        const sectionKey = answerKey.slice(start, end);
        
        let sectionHtml = `<div class="section">Section ${section + 1} (Q${start + 1}-Q${end})<br>`;
        let score = 0;
        
        for (let i = 0; i < 15; i++) {
          const student = sectionAnswers[i] || ' ';
          const correct = sectionKey[i];
          const isCorrect = student === correct;
          if (isCorrect) score++;
          
          sectionHtml += `<span class="${isCorrect ? 'correct' : 'incorrect'}">
            Q${start + i + 1}: ${student} (${correct}) ${isCorrect ? '✓' : '✗'}
          </span><br>`;
        }
        sectionHtml += `Score: ${score}/15</div>`;
        html += sectionHtml;
      }
      
      const totalScore = calculateScore(answers);
      html += `<br><b>Total Score: ${totalScore}/60</b>`;
      return html;
    }

    // Calculate total score
    function calculateScore(answers) {
      let score = 0;
      for (let i = 0; i < 60; i++) {
        if (answers[i] === answerKey[i]) score++;
      }
      return score;
    }
  </script>
</body>
</html>