<!DOCTYPE html>
<html>
<head>
  <title>Optimized Answer Sheet Scanner</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #video { width: 100%; max-width: 500px; border: 2px solid #ccc; }
    #result { margin-top: 20px; padding: 10px; background: #f0f0f0; }
    #input { margin: 10px 0; }
    #error { color: red; }
    .answers { font-family: monospace; white-space: pre-line; }
    .correct { color: green; }
    .incorrect { color: red; }
  </style>
</head>
<body>
  <h2>Answer Sheet Scanner</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div id="input">
    <label>Enter Answer Key (e.g., ABCDE...):</label>
    <input type="text" id="answerKey" maxlength="60" placeholder="ABCDE...">
    <button onclick="setKey()">Set Key</button>
  </div>
  
  <div id="result">Point camera at answer sheet...</div>
  <div id="error"></div>

  <script>
    // Get DOM elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    let answerKey = '';

    // Set answer key from input
    function setKey() {
      answerKey = document.getElementById('answerKey').value.toUpperCase();
      if (answerKey.length !== 60) {
        errorDiv.textContent = 'Answer key must be 60 characters long!';
        return;
      }
      errorDiv.textContent = '';
    }

    // Access camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        errorDiv.textContent = `Camera error: ${err.message}`;
      });

    // Start scanning when video loads
    video.addEventListener('loadedmetadata', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      requestAnimationFrame(scan);
    });

    // Main scanning loop
    function scan() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // Draw current frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Process image and detect answers
        const filteredData = removeGreenBackground(imageData);
        const answers = detectAnswers(filteredData);
        
        if (answers) {
          result.innerHTML = compareWithKey(answers);
        }
      }
      requestAnimationFrame(scan);
    }

    // Remove green background from image
    function removeGreenBackground(imageData) {
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Convert greenish pixels to grayscale
        if (g > r + 30 && g > b + 30) {
          const avg = (r + g + b) / 3;
          data[i] = avg;     // R
          data[i + 1] = avg; // G
          data[i + 2] = avg; // B
        }
      }
      return imageData;
    }

    // Detect marked answers
    function detectAnswers(imageData) {
      const ROWS = 15;
      const COLS = 24;
      const CELL_HEIGHT = 6 * 3; // 6mm scaled to pixels
      const CELL_WIDTHS = Array(24).fill(6 * 3); // Default 6mm
      [0, 6, 12, 18].forEach(i => CELL_WIDTHS[i] = 7 * 3); // Question columns

      const answers = [];
      for (let row = 0; row < ROWS; row++) {
        for (let col = 1; col < COLS; col++) {
          if ([6, 12, 18].includes(col)) continue; // Skip question columns

          // Calculate bubble center
          const x = 50 + CELL_WIDTHS.slice(0, col).reduce((a, b) => a + b, 0);
          const y = 50 + row * CELL_HEIGHT;

          // Check if bubble is shaded
          const brightness = getPixelBrightness(imageData, x, y);
          if (brightness < 100) {
            const option = String.fromCharCode(65 + (col - 1 - Math.floor(col / 6)));
            answers.push(option);
          }
        }
      }
      return answers.slice(0, 60); // Only first 60 items
    }

    // Get brightness of a pixel
    function getPixelBrightness(imageData, x, y) {
      const index = (y * imageData.width + x) * 4;
      const r = imageData.data[index];
      const g = imageData.data[index + 1];
      const b = imageData.data[index + 2];
      return (r + g + b) / 3;
    }

    // Compare answers with key
    function compareWithKey(studentAnswers) {
      if (!answerKey) return 'Set answer key first!';
      
      let score = 0;
      let details = 'Results:\n';
      
      for (let i = 0; i < 60; i++) {
        const student = studentAnswers[i] || ' ';
        const correct = answerKey[i];
        const isCorrect = student === correct;
        
        if (isCorrect) score++;
        
        details += `<span class="${isCorrect ? 'correct' : 'incorrect'}">
          Q${i + 1}: ${student} (${correct}) ${isCorrect ? '✓' : '✗'}
        </span>\n`;
      }
      
      return `Score: ${score}/60\n${details}`;
    }
  </script>
</body>
</html>